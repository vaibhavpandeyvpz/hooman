# Infrastructure: docker compose up -d redis chroma
# Full stack:     docker compose --profile full up -d
services:
  ngrok:
    image: ngrok/ngrok
    command:
      - start
      - --all
      - --config
      - /etc/ngrok.yml
    ports:
      - "4040:4040"
    profiles:
      - remote
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml
    env_file:
      - .env
    extra_hosts:
      - host.docker.internal:host-gateway

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  chroma:
    image: chromadb/chroma
    ports:
      - "8000:8000"
    volumes:
      - chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE

  # ── Backend services (profile: full) ────────────────────────────────

  migrate:
    build: .
    command: ["npx", "tsx", "scripts/db-migrate.ts"]
    profiles:
      - full
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CHROMA_URL=http://chroma:8000
    volumes:
      - workspace:/app/workspace
      - mcpcwd:/mcpcwd

  api:
    build: .
    ports:
      - "${PORT:-3000}:3000"
    profiles:
      - full
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CHROMA_URL=http://chroma:8000
      - ALLOW_REMOTE_ACCESS=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - mcpcwd:/mcpcwd
      - workspace:/app/workspace
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  event-queue:
    build: .
    command: ["npx", "tsx", "apps/backend/src/workers/event-queue.ts"]
    profiles:
      - full
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CHROMA_URL=http://chroma:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - mcpcwd:/mcpcwd
      - workspace:/app/workspace

  slack:
    build: .
    command: ["npx", "tsx", "apps/backend/src/workers/slack.ts"]
    profiles:
      - full
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CHROMA_URL=http://chroma:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - mcpcwd:/mcpcwd
      - workspace:/app/workspace

  whatsapp:
    build: .
    command: ["npx", "tsx", "apps/backend/src/workers/whatsapp.ts"]
    profiles:
      - full
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CHROMA_URL=http://chroma:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - mcpcwd:/mcpcwd
      - workspace:/app/workspace

  cron:
    build: .
    command: ["npx", "tsx", "apps/backend/src/workers/cron.ts"]
    profiles:
      - full
    depends_on:
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - CHROMA_URL=http://chroma:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - mcpcwd:/mcpcwd
      - workspace:/app/workspace

volumes:
  chroma-data:
  mcpcwd:
  redis-data:
  workspace:
